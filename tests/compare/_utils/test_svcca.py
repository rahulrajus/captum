import random

import numpy as np
import torch

from captum.compare.fb._utils.svcca import svcca
from tests.helpers.basic import BaseTest, assertTensorAlmostEqual


class Test(BaseTest):
    def test_svcca(self) -> None:
        # Basic Tests
        acts1 = torch.tensor(
            [
                [
                    -7.0318729e-01,
                    -4.9028236e-01,
                    -3.2181433e-01,
                    -1.7550787e00,
                    2.0666447e-01,
                    -2.0112646e00,
                    -5.5725068e-01,
                    3.3721700e-01,
                    1.5488360e00,
                    -1.3707366e00,
                    1.4252914e00,
                    -2.7946392e-01,
                    -5.5962789e-01,
                    1.1863834e00,
                    1.6985189e00,
                    -1.6912202e00,
                    -6.9952285e-01,
                    5.8296287e-01,
                    9.7822261e-01,
                    -1.2173721e00,
                ],
                [
                    -1.3293954e00,
                    -1.4547423e-03,
                    -1.3146527e00,
                    -3.7961173e-01,
                    1.2652106e00,
                    1.2066774e-01,
                    1.4794178e-01,
                    -2.7537258e00,
                    -3.5689631e-01,
                    7.7178366e-03,
                    1.4782772e00,
                    -9.5761460e-01,
                    1.3290081e00,
                    -9.8584962e-01,
                    4.7155720e-01,
                    -8.7465299e-03,
                    3.6701870e-01,
                    1.1185547e00,
                    -8.3899349e-03,
                    4.6631539e-01,
                ],
                [
                    1.2632687e00,
                    -9.0165466e-01,
                    -1.0288427e00,
                    5.6967843e-01,
                    6.4166480e-01,
                    2.5981194e-01,
                    1.1931782e00,
                    -1.0463004e00,
                    1.3988893e-01,
                    -1.7306558e00,
                    -1.3062312e-01,
                    -1.3102601e00,
                    -2.1713123e00,
                    -1.0661814e00,
                    -3.3161845e-02,
                    1.4663957e00,
                    8.7664312e-01,
                    6.6998959e-01,
                    6.9744951e-01,
                    -2.5278544e-01,
                ],
                [
                    5.6798708e-01,
                    3.0438787e-01,
                    -1.0000296e00,
                    -2.4564178e00,
                    2.5230703e-01,
                    7.6312041e-01,
                    -1.5834546e00,
                    1.9804229e-01,
                    8.5252233e-02,
                    6.4050776e-01,
                    -7.9065818e-01,
                    7.7118242e-01,
                    -1.9506778e00,
                    -1.2940102e00,
                    -1.0735238e00,
                    3.0691093e-02,
                    7.7410936e-01,
                    -8.7139630e-01,
                    1.6634402e-01,
                    6.3578975e-01,
                ],
                [
                    1.0816720e00,
                    -2.8277367e-01,
                    1.5547880e00,
                    -8.5830814e-01,
                    -2.7965042e-01,
                    -8.5423432e-02,
                    -2.1959765e-01,
                    -2.1735988e00,
                    9.0633243e-01,
                    7.5033855e-01,
                    -5.7525975e-01,
                    -3.6895323e-01,
                    7.6574826e-01,
                    -1.1006616e00,
                    7.3382968e-01,
                    -3.1574022e-02,
                    -1.2739419e00,
                    3.3035865e-01,
                    -5.4251516e-01,
                    -1.0520285e00,
                ],
            ]
        )
        acts2 = torch.tensor(
            [
                [
                    -0.77572066,
                    -0.12322816,
                    -0.5369313,
                    0.1653734,
                    0.89985573,
                    1.257196,
                    1.1540686,
                    -0.6742258,
                    0.8832667,
                    -1.800741,
                    0.315524,
                    -0.29894245,
                    0.9232667,
                    -0.86461043,
                    0.9063239,
                    0.14366536,
                    -0.42878404,
                    0.04363349,
                    -1.1596302,
                    -0.14458172,
                ],
                [
                    1.0626972,
                    1.5034816,
                    0.8904773,
                    0.11018473,
                    -0.28087837,
                    0.47087678,
                    -0.12265481,
                    1.8097161,
                    -0.21150403,
                    -0.10491642,
                    0.5600093,
                    -1.1794564,
                    -0.46780378,
                    -1.7424132,
                    -0.00370322,
                    -2.170067,
                    0.42451006,
                    0.14647864,
                    0.05927444,
                    -0.4912539,
                ],
                [
                    -1.017173,
                    0.4193072,
                    -0.7713675,
                    1.4378865,
                    2.686767,
                    0.3967329,
                    0.47692397,
                    0.8159017,
                    -0.5030922,
                    0.1448642,
                    0.03915845,
                    -0.61283594,
                    0.70088214,
                    0.9768649,
                    -0.6309415,
                    -0.8386027,
                    -0.43920365,
                    -1.3645267,
                    -1.2723712,
                    0.86019087,
                ],
                [
                    0.9148604,
                    -0.71286017,
                    0.15607764,
                    1.1585562,
                    -0.49821013,
                    1.670691,
                    0.4317653,
                    0.42671204,
                    0.986746,
                    0.9776806,
                    -1.0646682,
                    0.5388479,
                    0.84308255,
                    0.9007229,
                    -0.80167735,
                    0.48713082,
                    -0.3583996,
                    1.2029767,
                    0.4586992,
                    -1.1196308,
                ],
                [
                    0.3351304,
                    -0.6869002,
                    1.2068168,
                    1.917521,
                    0.54219896,
                    0.7223536,
                    -0.17488135,
                    -0.11599682,
                    -1.9871268,
                    0.00998292,
                    0.07121492,
                    -1.7500412,
                    0.55443835,
                    0.27454585,
                    1.720705,
                    -2.3942127,
                    -0.43833584,
                    1.2219813,
                    0.37437698,
                    -1.3810042,
                ],
            ]
        )
        _, actual_stats = svcca(acts1.T, acts2.T)
        expected_stats = {
            "coef_x": torch.tensor(
                [
                    [-0.52821659, 0.6007337, -0.37048688, -0.47206539],
                    [-0.25611665, 0.56047499, 0.45354282, 0.64387185],
                    [-0.77831507, -0.53899517, 0.31583972, -0.0628898],
                    [-0.22274906, -0.18566372, -0.74651434, 0.59885573],
                ]
            ),
            "invsqrt_xx": torch.tensor(
                [
                    [1.00000000e00, 7.99919369e-09, -6.41036178e-09, 5.35795733e-09],
                    [7.99919369e-09, 1.07222868e00, 5.46313976e-09, 4.65392261e-10],
                    [-6.41036178e-09, 5.46313976e-09, 1.19223421e00, -1.42410747e-09],
                    [5.35795733e-09, 4.65392261e-10, -1.42410747e-09, 1.36566631e00],
                ]
            ),
            "full_coef_x": torch.tensor(
                [
                    [-0.52821659, 0.6007337, -0.37048688, -0.47206539],
                    [-0.25611665, 0.56047499, 0.45354282, 0.64387185],
                    [-0.77831507, -0.53899517, 0.31583972, -0.0628898],
                    [-0.22274906, -0.18566372, -0.74651434, 0.59885573],
                ]
            ),
            "full_invsqrt_xx": torch.tensor(
                [
                    [1.00000000e00, 7.99919369e-09, -6.41036178e-09, 5.35795733e-09],
                    [7.99919369e-09, 1.07222868e00, 5.46313976e-09, 4.65392261e-10],
                    [-6.41036178e-09, 5.46313976e-09, 1.19223421e00, -1.42410747e-09],
                    [5.35795733e-09, 4.65392261e-10, -1.42410747e-09, 1.36566631e00],
                ]
            ),
            "coef_y": torch.tensor(
                [
                    [-0.46444825, 0.42857771, 0.60085596, -0.48947021],
                    [0.36834476, -0.16792995, -0.29933992, -0.86401232],
                    [-0.80533393, -0.33100468, -0.47860568, -0.11318027],
                    [0.00687228, -0.82374545, 0.56595436, -0.03304331],
                ]
            ),
            "invsqrt_yy": torch.tensor(
                [
                    [1.00000000e00, 5.36623693e-10, 1.59260409e-09, -2.35199210e-09],
                    [5.36623693e-10, 1.19622732e00, 4.06272616e-09, 7.75816336e-11],
                    [1.59260409e-09, 4.06272616e-09, 1.41084960e00, 2.64991697e-09],
                    [-2.35199210e-09, 7.75816336e-11, 2.64991697e-09, 1.71592518e00],
                ]
            ),
            "full_coef_y": torch.tensor(
                [
                    [-0.46444825, 0.42857771, 0.60085596, -0.48947021],
                    [0.36834476, -0.16792995, -0.29933992, -0.86401232],
                    [-0.80533393, -0.33100468, -0.47860568, -0.11318027],
                    [0.00687228, -0.82374545, 0.56595436, -0.03304331],
                ]
            ),
            "full_invsqrt_yy": torch.tensor(
                [
                    [1.00000000e00, 5.36623693e-10, 1.59260409e-09, -2.35199210e-09],
                    [5.36623693e-10, 1.19622732e00, 4.06272616e-09, 7.75816336e-11],
                    [1.59260409e-09, 4.06272616e-09, 1.41084960e00, 2.64991697e-09],
                    [-2.35199210e-09, 7.75816336e-11, 2.64991697e-09, 1.71592518e00],
                ]
            ),
            "cca_coef": torch.tensor([0.71491602, 0.54097356, 0.18198371, 0.11379747]),
            "x_idxs": torch.tensor([True, True, True, True]),
            "y_idxs": torch.tensor([True, True, True, True]),
            "mean": (0.4792910967),
            "cca_directions1": torch.tensor(
                [
                    [
                        1.01267296,
                        0.67313693,
                        -0.04456646,
                        -2.27463581,
                        -0.23383057,
                        0.54339333,
                        -1.68671631,
                        2.3718005,
                        0.66065352,
                        0.9086279,
                        -0.96912957,
                        1.75569102,
                        -2.08409503,
                        0.03104296,
                        -0.82478276,
                        -0.2978231,
                        0.64466906,
                        -1.2567175,
                        0.49533763,
                        0.5752718,
                    ],
                    [
                        -0.6809029,
                        0.16617804,
                        1.17251839,
                        2.38251079,
                        -1.71323375,
                        -0.13061976,
                        0.31309911,
                        2.32217135,
                        -1.43928321,
                        0.40081504,
                        -1.23723107,
                        0.57802463,
                        1.16055223,
                        1.42879629,
                        -1.08771166,
                        -0.33766694,
                        -0.80980809,
                        -1.28233931,
                        -1.17232807,
                        -0.03354108,
                    ],
                    [
                        1.02268231,
                        0.21319706,
                        -0.31439993,
                        0.93907374,
                        0.20585845,
                        2.13955071,
                        0.39729547,
                        -1.40980436,
                        -1.38171711,
                        1.04684875,
                        -1.43190558,
                        -0.16655167,
                        -0.27117953,
                        -2.12969625,
                        -1.74397926,
                        1.96263139,
                        0.95765941,
                        -0.37916041,
                        -0.80295141,
                        1.1465487,
                    ],
                    [
                        0.27339295,
                        -0.76759984,
                        -1.62336921,
                        1.58538779,
                        0.24248948,
                        -0.28379134,
                        1.36298057,
                        1.62960994,
                        -0.43879521,
                        -2.50428413,
                        0.17049217,
                        -0.8359134,
                        -2.56171456,
                        0.66357651,
                        -0.39794763,
                        0.9528966,
                        1.28872126,
                        0.1378498,
                        1.01429656,
                        0.09172204,
                    ],
                ]
            ),
            "cca_directions2": torch.tensor(
                [
                    [
                        0.8653188,
                        1.48253459,
                        0.26628156,
                        -1.80765949,
                        -1.32647537,
                        -2.23793297,
                        -1.28382407,
                        1.35378296,
                        -0.0056954,
                        1.66488018,
                        0.34998022,
                        0.98294032,
                        -1.79718243,
                        -0.15325831,
                        -1.6003712,
                        0.59074655,
                        1.20380671,
                        -1.01267356,
                        1.10428813,
                        1.36051295,
                    ],
                    [
                        -0.05429696,
                        -0.74568442,
                        0.01668328,
                        2.20231802,
                        1.33409189,
                        -0.3914736,
                        -0.93352883,
                        0.8688972,
                        -2.05360762,
                        2.39452956,
                        -1.11375183,
                        -0.61224615,
                        0.12618059,
                        2.67838325,
                        -1.38436053,
                        -1.31826244,
                        -0.59706418,
                        -0.5050013,
                        0.27701411,
                        -0.18881994,
                    ],
                    [
                        -1.16498652,
                        -1.39898225,
                        -1.66003665,
                        -0.44019644,
                        0.23402796,
                        -0.15242341,
                        0.37880049,
                        -1.47741918,
                        1.35708408,
                        0.28876249,
                        -1.07150947,
                        1.90569119,
                        0.53687457,
                        1.86466464,
                        -1.34804511,
                        3.10401092,
                        -0.55071175,
                        -0.65884265,
                        -0.48309096,
                        0.73632814,
                    ],
                    [
                        -1.50999327,
                        1.6368691,
                        -1.004485,
                        -0.01847997,
                        2.94293259,
                        -0.50697524,
                        0.64565941,
                        0.84556148,
                        -0.0944857,
                        -0.96793107,
                        1.20317868,
                        -0.50120337,
                        0.13277201,
                        -0.36885242,
                        -0.13535515,
                        -0.53282539,
                        0.18606102,
                        -2.32363927,
                        -1.74848373,
                        2.1196755,
                    ],
                ]
            ),
        }

        for stat in expected_stats:
            expected_tensor = expected_stats[stat]
            actual_tensor = actual_stats[stat]
            if actual_tensor.dtype is torch.float32:
                assertTensorAlmostEqual(self, actual_tensor, expected_tensor, mode='max')
            else:
                self.assertTrue(
                    torch.equal(expected_tensor, actual_tensor),
                    msg=f"{stat} does not match",
                )
